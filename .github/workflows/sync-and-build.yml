name: Sync Fork and Build Docker Image

on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯å¤© UTC æ—¶é—´ 0 ç‚¹æ‰§è¡Œä¸€æ¬¡åŒæ­¥
  schedule:
    - cron: '0 0 * * *'
  
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸æ‚¨åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  workflow_dispatch:

  # 3. Push è§¦å‘ï¼šå½“æœ‰ä»£ç æ¨é€åˆ° master åˆ†æ”¯æ—¶ï¼Œè§¦å‘æ„å»ºå’Œæ¨é€ä½œä¸š
  push:
    branches:
      - master
    paths-ignore:
      - 'README.md'
      - '.gitignore'

jobs:
  # ä½œä¸šä¸€ï¼šåŒæ­¥ä¸Šæ¸¸ä»“åº“
  sync_fork:
    runs-on: ubuntu-latest
    # ä»…åœ¨å®šæ—¶æˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œæ­¤ä½œä¸š
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          # éœ€è¦ä¸€ä¸ªæœ‰å†™æƒé™çš„ PAT (Personal Access Token) æ¥æ¨é€æ›´æ–°
          token: ${{ secrets.PAT_TOKEN }}

      - name: Backup workflow files
        run: |
          # å¤‡ä»½ .github ç›®å½•åˆ°ä¸´æ—¶ä½ç½®
          cp -r .github /tmp/github-backup || echo "å¤‡ä»½å¤±è´¥ï¼Œå¯èƒ½æ˜¯é¦–æ¬¡è¿è¡Œ"

      - name: Smart sync with upstream (ä¿æŠ¤ .github ç›®å½•)
        run: |
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ä»“åº“
          git remote add upstream https://github.com/su-kaka/gcli2api.git 2>/dev/null || echo "ä¸Šæ¸¸è¿œç¨‹ä»“åº“å·²å­˜åœ¨"
          
          # æ‹‰å–ä¸Šæ¸¸æ›´æ–°
          git fetch upstream master
          
          # åˆ‡æ¢åˆ°ä¸´æ—¶åˆ†æ”¯è¿›è¡Œåˆå¹¶
          git checkout -b temp-sync-branch
          
          # å°†ä¸Šæ¸¸çš„å˜æ›´åˆå¹¶åˆ°ä¸´æ—¶åˆ†æ”¯ï¼Œä½†æ’é™¤ .github ç›®å½•
          git merge upstream/master --no-edit --allow-unrelated-histories || {
            echo "åˆå¹¶å†²çªï¼Œå°è¯•å¼ºåˆ¶åŒæ­¥é™¤ .github å¤–çš„æ‰€æœ‰æ–‡ä»¶"
            
            # é‡ç½®åˆ°ä¸Šæ¸¸çŠ¶æ€ï¼Œä½†ä¿æŠ¤ .github ç›®å½•
            git reset --hard upstream/master
            
            # æ¢å¤ .github ç›®å½•
            if [ -d "/tmp/github-backup" ]; then
              cp -r /tmp/github-backup .github
              echo "âœ… å·²æ¢å¤ .github ç›®å½•"
            fi
          }
          
          # åˆ‡æ¢å› master åˆ†æ”¯å¹¶åº”ç”¨æ›´æ”¹
          git checkout master
          git merge temp-sync-branch --no-edit
          
          # ç¡®ä¿ .github ç›®å½•å­˜åœ¨å¹¶åŒ…å«å·¥ä½œæµ
          if [ ! -f ".github/workflows/sync-and-build.yml" ]; then
            echo "âš ï¸ å·¥ä½œæµæ–‡ä»¶ä¸¢å¤±ï¼Œæ­£åœ¨æ¢å¤..."
            mkdir -p .github/workflows
            if [ -f "/tmp/github-backup/workflows/sync-and-build.yml" ]; then
              cp /tmp/github-backup/workflows/sync-and-build.yml .github/workflows/
              echo "âœ… å·²ä»å¤‡ä»½æ¢å¤å·¥ä½œæµæ–‡ä»¶"
            fi
          fi
          
          # æ¸…ç†ä¸´æ—¶åˆ†æ”¯
          git branch -D temp-sync-branch 2>/dev/null || echo "ä¸´æ—¶åˆ†æ”¯æ¸…ç†å®Œæˆ"
          
          # æ¨é€æ›´æ–°
          git push origin master
          
          echo "ğŸ‰ æ™ºèƒ½åŒæ­¥å®Œæˆï¼Œ.github ç›®å½•å·²å—ä¿æŠ¤"

  # ä½œä¸šäºŒï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒ
  build_and_push:
    runs-on: ubuntu-latest
    # ä»…åœ¨ä»£ç è¢«æ¨é€åˆ° master åˆ†æ”¯æ—¶è¿è¡Œæ­¤ä½œä¸š
    # (åŒæ­¥ä½œä¸šæˆåŠŸåä¼šäº§ç”Ÿä¸€æ¬¡ pushï¼Œä»è€Œè§¦å‘æ­¤ä½œä¸š)
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write # éœ€è¦ 'packages' çš„å†™æƒé™æ¥æ¨é€é•œåƒåˆ° GHCR
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }} # è‡ªåŠ¨è·å–æ‚¨çš„ GitHub ç”¨æˆ·å
          password: ${{ secrets.GITHUB_TOKEN }}   # ä½¿ç”¨ GitHub è‡ªåŠ¨æä¾›çš„ GITHUB_TOKEN

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/gcli2api
          tags: |
            # ä¸ºé•œåƒæ·»åŠ ä¸¤ä¸ªæ ‡ç­¾:
            # 1. å…·ä½“ç‰ˆæœ¬å· (commit SHA)
            type=sha
            # 2. å½“æ¨é€åˆ°é»˜è®¤åˆ†æ”¯ (master) æ—¶ï¼Œæ·»åŠ  'latest' æ ‡ç­¾
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
