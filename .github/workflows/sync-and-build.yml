name: Sync Fork and Build Docker Image

on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯å¤© UTC æ—¶é—´ 0 ç‚¹æ‰§è¡Œä¸€æ¬¡åŒæ­¥
  schedule:
    - cron: '0 0 * * *'
  
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸æ‚¨åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  workflow_dispatch:

  # 3. Push è§¦å‘ï¼šå½“æœ‰ä»£ç æŽ¨é€åˆ° master åˆ†æ”¯æ—¶ï¼Œè§¦å‘æž„å»ºå’ŒæŽ¨é€ä½œä¸š
  push:
    branches:
      - master
    paths-ignore:
      - 'README.md'
      - '.gitignore'

jobs:
  # ä½œä¸šä¸€ï¼šåŒæ­¥ä¸Šæ¸¸ä»“åº“
  sync_fork:
    runs-on: ubuntu-latest
    # ä»…åœ¨å®šæ—¶æˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œæ­¤ä½œä¸š
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          # éœ€è¦ä¸€ä¸ªæœ‰å†™æƒé™çš„ PAT (Personal Access Token) æ¥æŽ¨é€æ›´æ–°
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0  # èŽ·å–å®Œæ•´çš„åŽ†å²è®°å½•

      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: å®‰å…¨åŒæ­¥ä¸Šæ¸¸ä»“åº“ (ä¿æŠ¤ .github ç›®å½•)
        run: |
          echo "ðŸ”„ å¼€å§‹å®‰å…¨åŒæ­¥æµç¨‹..."
          
          # æ£€æŸ¥å½“å‰çŠ¶æ€
          echo "ðŸ“Š å½“å‰ä»“åº“çŠ¶æ€:"
          git status --porcelain
          
          # æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ä»“åº“ (å¦‚æžœä¸å­˜åœ¨)
          if ! git remote get-url upstream >/dev/null 2>&1; then
            echo "âž• æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ä»“åº“..."
            git remote add upstream https://github.com/su-kaka/gcli2api.git
          else
            echo "âœ… ä¸Šæ¸¸è¿œç¨‹ä»“åº“å·²å­˜åœ¨"
          fi
          
          # èŽ·å–ä¸Šæ¸¸æ›´æ–°
          echo "ðŸ“¥ èŽ·å–ä¸Šæ¸¸æ›´æ–°..."
          git fetch upstream master
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
          LOCAL_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/master)
          
          if [ "$LOCAL_COMMIT" = "$UPSTREAM_COMMIT" ]; then
            echo "âœ… ä»“åº“å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€åŒæ­¥"
            exit 0
          fi
          
          echo "ðŸ” æ£€æµ‹åˆ°ä¸Šæ¸¸æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
          echo "æœ¬åœ°æäº¤: $LOCAL_COMMIT"
          echo "ä¸Šæ¸¸æäº¤: $UPSTREAM_COMMIT"
          
          # é…ç½® sparse-checkout æ¥ä¿æŠ¤ .github ç›®å½•
          echo "ðŸ›¡ï¸ é…ç½® sparse-checkout ä¿æŠ¤ .github ç›®å½•..."
          git config core.sparseCheckout true
          
          # è®¾ç½® sparse-checkout è§„åˆ™ï¼šåŒ…å«æ‰€æœ‰æ–‡ä»¶ä½†æŽ’é™¤ .github ç›®å½•
          cat > .git/info/sparse-checkout << 'EOF'
          /*
          !/.github/
          EOF
          
          # åˆ›å»ºä¸€ä¸ªä¸´æ—¶åˆ†æ”¯è¿›è¡Œåˆå¹¶æ“ä½œ
          echo "ðŸŒ¿ åˆ›å»ºä¸´æ—¶åˆ†æ”¯..."
          git checkout -b temp-sync-$(date +%Y%m%d-%H%M%S)
          
          # ä½¿ç”¨ sparse-checkout è¯»å–ä¸Šæ¸¸æ›´æ”¹
          echo "ðŸ“ åº”ç”¨ä¸Šæ¸¸æ›´æ”¹ (æŽ’é™¤ .github ç›®å½•)..."
          git read-tree -u upstream/master
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹åˆ°æš‚å­˜åŒº
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹"
          else
            echo "ðŸ’¾ æäº¤åŒæ­¥æ›´æ”¹..."
            git commit -m "sync: åŒæ­¥ä¸Šæ¸¸ä»“åº“æ›´æ”¹ (ä¿æŠ¤ .github ç›®å½•)"
          fi
          
          # åˆ‡æ¢å›ž master åˆ†æ”¯
          echo "ðŸ”„ åˆ‡æ¢å›ž master åˆ†æ”¯..."
          git checkout master
          
          # åˆå¹¶ä¸´æ—¶åˆ†æ”¯çš„æ›´æ”¹
          echo "ðŸ”— åˆå¹¶åŒæ­¥æ›´æ”¹..."
          git merge temp-sync-$(date +%Y%m%d-%H%M%S) --no-edit
          
          # æ¸…ç†ä¸´æ—¶åˆ†æ”¯
          echo "ðŸ§¹ æ¸…ç†ä¸´æ—¶åˆ†æ”¯..."
          git branch -D temp-sync-$(date +%Y%m%d-%H%M%S)
          
          # ç¦ç”¨ sparse-checkout
          echo "ðŸ”§ æ¢å¤æ­£å¸¸çš„ checkout æ¨¡å¼..."
          git config core.sparseCheckout false
          
          # éªŒè¯å…³é”®æ–‡ä»¶
          echo "âœ… éªŒè¯å…³é”®æ–‡ä»¶å®Œæ•´æ€§..."
          if [ ! -f ".github/workflows/sync-and-build.yml" ]; then
            echo "âŒ é”™è¯¯: å·¥ä½œæµæ–‡ä»¶ä¸¢å¤±!"
            exit 1
          fi
          
          echo "ðŸ“Š æœ€ç»ˆçŠ¶æ€æ£€æŸ¥:"
          git status --porcelain
          
          # æŽ¨é€æ›´æ–°
          echo "ðŸš€ æŽ¨é€æ›´æ–°åˆ°è¿œç¨‹ä»“åº“..."
          git push origin master
          
          echo "ðŸŽ‰ åŒæ­¥å®Œæˆ! .github ç›®å½•å·²å—åˆ°ä¿æŠ¤"

  # ä½œä¸šäºŒï¼šæž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
  build_and_push:
    runs-on: ubuntu-latest
    # ä»…åœ¨ä»£ç è¢«æŽ¨é€åˆ° master åˆ†æ”¯æ—¶è¿è¡Œæ­¤ä½œä¸š
    # (åŒæ­¥ä½œä¸šæˆåŠŸåŽä¼šäº§ç”Ÿä¸€æ¬¡ pushï¼Œä»Žè€Œè§¦å‘æ­¤ä½œä¸š)
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write # éœ€è¦ 'packages' çš„å†™æƒé™æ¥æŽ¨é€é•œåƒåˆ° GHCR
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }} # è‡ªåŠ¨èŽ·å–æ‚¨çš„ GitHub ç”¨æˆ·å
          password: ${{ secrets.GITHUB_TOKEN }}   # ä½¿ç”¨ GitHub è‡ªåŠ¨æä¾›çš„ GITHUB_TOKEN

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/gcli2api
          tags: |
            # ä¸ºé•œåƒæ·»åŠ ä¸¤ä¸ªæ ‡ç­¾:
            # 1. å…·ä½“ç‰ˆæœ¬å· (commit SHA)
            type=sha
            # 2. å½“æŽ¨é€åˆ°é»˜è®¤åˆ†æ”¯ (master) æ—¶ï¼Œæ·»åŠ  'latest' æ ‡ç­¾
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
